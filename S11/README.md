# ì„¹ì…˜11. í…ŒìŠ¤íŠ¸ í•´ë³´ê¸°(ë‹¨ìœ„, í†µí•©, ë¶€í•˜)

1. [ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ í•´ë³´ê¸°](#ë‹¨ìœ„-í…ŒìŠ¤íŠ¸-í•´ë³´ê¸°)
2. [í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì‚´í´ë³´ê¸°](#í…ŒìŠ¤íŠ¸-ì»¤ë²„ë¦¬ì§€-ì‚´í´ë³´ê¸°)
3. [í†µí•© í…ŒìŠ¤íŠ¸ í•´ë³´ê¸°](#í†µí•©-í…ŒìŠ¤íŠ¸-í•´ë³´ê¸°)
4. [ë¶€í•˜ í…ŒìŠ¤íŠ¸ í•´ë³´ê¸°](#ë¶€í•˜-í…ŒìŠ¤íŠ¸-í•´ë³´ê¸°)

---

## ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ í•´ë³´ê¸°

- í…ŒìŠ¤íŠ¸ë¥¼ ì•„ë¬´ë¦¬ ì² ì €í•˜ê²Œ í•˜ë”ë¼ë„ ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ” ê²ƒì„ ì™„ì „íˆ ë§‰ì„ ìˆ˜ëŠ” ì—†ìŒ.
- ë³´í†µ ì—ëŸ¬ëŠ” ê°œë°œìê°€ ì˜ˆìƒí•˜ì§€ ëª»í•œ ì¼€ì´ìŠ¤ì—ì„œ ë°œìƒí•˜ë¯€ë¡œ, ì˜ˆìƒí•˜ì§€ ëª»í•œë‹¤ë©´ ê·¸ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ë„ ì‘ì„±í•  ìˆ˜ ì—†ìŒ.

- ê¸°ì¡´ì— ë§Œë“¤ì—ˆë˜ nodebird í”„ë¡œì íŠ¸ì— í…ŒìŠ¤íŠ¸í•˜ê¸°

```
npm i -D jest
```

![Image](https://github.com/user-attachments/assets/37087a84-729e-44a9-919c-700f03950ec8)

- í…ŒìŠ¤íŠ¸ íŒŒì¼ : spec.js, test.js

### 1. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì˜ ê¸°ë³¸ êµ¬ì¡°

```
describe('í…ŒìŠ¤íŠ¸ ê·¸ë£¹ ì„¤ëª…', () => {
  test('ê°œë³„ í…ŒìŠ¤íŠ¸ ì„¤ëª…', () => {
    // í…ŒìŠ¤íŠ¸ ì½”ë“œ
  });
});
```

- `describe`: ì—°ê´€ëœ í…ŒìŠ¤íŠ¸ë“¤ì„ ë…¼ë¦¬ì ìœ¼ë¡œ ê·¸ë£¹í™”
- í•˜ë‚˜ì˜ í•¨ìˆ˜ = í•˜ë‚˜ì˜ í…ŒìŠ¤íŠ¸ ë‹¨ìœ„
- ë¶„ê¸° ì²˜ë¦¬(ifë¬¸, try-catch ë“±)ë³„ë¡œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì‘ì„±í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ

## 2. Jestì˜ ëª¨ì˜(Mock) í•¨ìˆ˜

```
// âŒ ì¼ë°˜ í•¨ìˆ˜ - Jestê°€ í˜¸ì¶œ ì¶”ì  ë¶ˆê°€
const next = function() {};

// âœ… Jest ëª¨ì˜ í•¨ìˆ˜ - í˜¸ì¶œ ì¶”ì  ê°€ëŠ¥
const next = jest.fn();
```

## 3. ì²´ì´ë‹ì„ ìœ„í•œ ëª¨ì˜ ê°ì²´ ìƒì„±

```
const res = {
  status: jest.fn(() => res), // ì²´ì´ë‹ì„ ìœ„í•´ res ë°˜í™˜
  send: jest.fn(),
  json: jest.fn(),
};

// ì‚¬ìš© ì˜ˆ: res.status(404).send('Not Found')
```

### 4. Jestì˜ ê²€ì¦ í•¨ìˆ˜ë“¤

```
// í•¨ìˆ˜ í˜¸ì¶œ ì—¬ë¶€ ê²€ì¦
expect(next).toBeCalledTimes(1);

// íŠ¹ì • ì¸ìë¡œ í˜¸ì¶œëëŠ”ì§€ ê²€ì¦
expect(res.status).toBeCalledWith(403);

// ë°˜í™˜ê°’ ê²€ì¦
expect(result).toBe(expectedValue);
```

### 5. ëª¨ë“ˆ ëª¨í‚¹

```
// ëª¨ë“ˆ ì „ì²´ë¥¼ ëª¨í‚¹
jest.mock("../models/user");

// íŠ¹ì • í•¨ìˆ˜ë§Œ ëª¨í‚¹
User.findOne.mockReturnValue({
  addFollowing(id) {
    return Promise.resolve(true);
  },
});
```

### 6. ê³„ì¸µë³„ ë¡œì§ ë¶„ë¦¬

- ì»¨íŠ¸ë¡¤ëŸ¬ : req, res ê°ì²´ í•„ìš”
- ì„œë¹„ìŠ¤ : req, res ê°ì²´ ë¶ˆí•„ìš”

### 7. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ì£¼ê¸°

```
describe('User API', () => {
  beforeAll(() => {
    // í…ŒìŠ¤íŠ¸ ì‹œì‘ ì „ 1íšŒ ì‹¤í–‰
    // DB ì—°ê²° ë“±
  });

  afterAll(() => {
    // ëª¨ë“  í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ 1íšŒ ì‹¤í–‰
    // DB ì—°ê²° ì¢…ë£Œ ë“±
  });

  beforeEach(() => {
    // ê° í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‹œì‘ ì „ ì‹¤í–‰
    // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì´ˆê¸°í™” ë“±
  });

  afterEach(() => {
    // ê° í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì™„ë£Œ í›„ ì‹¤í–‰
    // ëª¨ì˜ í•¨ìˆ˜ ì´ˆê¸°í™” ë“±
    jest.clearAllMocks();
  });
});
```

### 8. exportsì™€ module.exports

[exportsì™€ module.exports](./exports/README.md)

---

## í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì‚´í´ë³´ê¸°

- í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ëŠ” ì½”ë“œê°€ í…ŒìŠ¤íŠ¸ì— ì˜í•´ ì–¼ë§ˆë‚˜ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì§€í‘œ

### ì»¤ë²„ë¦¬ì§€ì˜ íŠ¹ì§•

- ì „ì²´ í”„ë¡œì íŠ¸ê°€ ì•„ë‹Œ ì‘ì„±í•œ ì½”ë“œ ì¤‘ í…ŒìŠ¤íŠ¸ëœ ë¹„ìœ¨ì„ ë³´ì—¬ì¤Œ
- í•¨ìˆ˜ë‚˜ ë©”ì„œë“œë¥¼ ë‹¨ìˆœíˆ í˜¸ì¶œë§Œ í•´ë„ ì»¤ë²„ë¦¬ì§€ê°€ ì˜¬ë¼ê°
- ë†’ì€ ì»¤ë²„ë¦¬ì§€ê°€ ë°˜ë“œì‹œ ì¢‹ì€ í…ŒìŠ¤íŠ¸ë¥¼ ì˜ë¯¸í•˜ì§€ëŠ” ì•ŠìŒ

### ğŸ‘ ì˜ëª»ëœ ì»¤ë²„ë¦¬ì§€ ë†’ì´ê¸° ì˜ˆì‹œ

- user.test.js

```
describe("User ëª¨ë¸", () => {
  test("static init ë©”ì„œë“œ í˜¸ì¶œ", () => {
    // init ë©”ì„œë“œì˜ ë‚´ë¶€ ë¡œì§ì€ í…ŒìŠ¤íŠ¸í•˜ì§€ ì•Šê³ 
    // ë‹¨ìˆœíˆ í˜¸ì¶œë§Œ í•´ì„œ ì»¤ë²„ë¦¬ì§€ë¥¼ ì˜¬ë¦¼
    expect(User.initiate(sequelize)).toBe(undefined);
  });
});
```

### ğŸ‘ ì˜ë¯¸ ìˆëŠ” í…ŒìŠ¤íŠ¸ ì‘ì„± ë°©ë²•

```
describe("User ëª¨ë¸", () => {
  test("static init ë©”ì„œë“œê°€ ì˜¬ë°”ë¥¸ ëª¨ë¸ì„ ì´ˆê¸°í™”í•´ì•¼ í•¨", () => {
    User.initiate(sequelize);

    // ì‹¤ì œë¡œ ëª¨ë¸ì´ ì˜¬ë°”ë¥´ê²Œ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ ê²€ì¦
    expect(User.rawAttributes.email.type instanceof Sequelize.STRING).toBe(true);
    expect(User.rawAttributes.email.unique).toBe(true);
    expect(User.rawAttributes.nick.allowNull).toBe(false);
    // ... ë‹¤ë¥¸ ì¤‘ìš”í•œ ì†ì„±ë“¤ë„ ê²€ì¦
  });
});
```

### í…ŒìŠ¤íŠ¸ ì‘ì„± ì‹œ ì£¼ì˜ì‚¬í•­

- ë‹¨ìˆœ í˜¸ì¶œì´ ì•„ë‹Œ ê²°ê³¼ ê²€ì¦
- ê²½ê³„ê°’ ë° ì˜ˆì™¸ ìƒí™© í…ŒìŠ¤íŠ¸
- ì˜ë¯¸ ìˆëŠ” í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
- ì¤‘ìš” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìš°ì„ 

<details>
<summary><i>í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì¶œë ¥</i></summary>

![Image](https://github.com/user-attachments/assets/152fbff6-770a-4f8c-a8d8-23f2880eaca9)

</details>

---

## í†µí•© í…ŒìŠ¤íŠ¸ í•´ë³´ê¸°

### 1. í†µí•© í…ŒìŠ¤íŠ¸ì˜ ê°œë…

- ê°œë³„ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì™€ ë‹¬ë¦¬ ì—¬ëŸ¬ ì»´í¬ë„ŒíŠ¸ë¥¼ í•¨ê»˜ í…ŒìŠ¤íŠ¸
- ì‹¤ì œ ì„œë²„ ì‹¤í–‰ ì—†ì´ ë¼ìš°í„°, ì»¨íŠ¸ë¡¤ëŸ¬, ì„œë¹„ìŠ¤ ë ˆì´ì–´ ë“±ì„ í†µí•©ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸

### 2. ì„œë²„ ì„¤ì • ë¶„ë¦¬

- `supertest`ëŠ” app ê°ì²´ë§Œ í•„ìš”í•˜ë¯€ë¡œ `listen` ë¶€ë¶„ ë¶„ë¦¬
- `package.json`ì˜ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ë¥¼ `server.js`ë¡œ ìˆ˜ì •

#### ì „

```
// app.js
app.listen(app.get('port'), () => {
  console.log(app.get('port'), 'ë²ˆ í¬íŠ¸ì—ì„œ ëŒ€ê¸° ì¤‘');
});
```

#### í›„

```
// app.js
module.exports = app;

// server.js (ìƒˆë¡œ ìƒì„±)
const app = require('./app');
app.listen(app.get('port'), () => {
  console.log(app.get('port'), 'ë²ˆ í¬íŠ¸ì—ì„œ ëŒ€ê¸° ì¤‘');
});
```

### 3. í…ŒìŠ¤íŠ¸ DB ì„¤ì •

- ìš´ì˜ DBì™€ í…ŒìŠ¤íŠ¸ DBë¥¼ ë¶„ë¦¬
- ë™ì¼í•œ í…Œì´ë¸” êµ¬ì¡° ìœ ì§€
- config/config.jsonì—ì„œ test í™˜ê²½ ì„¤ì •

```
npx sequelize db:create --env test
```

<details>
<summary><i>ì‹¤í–‰ê²°ê³¼</i></summary>

![Image](https://github.com/user-attachments/assets/483abdfd-91fe-4d72-bf63-7a0e6ba924c3)

</details>

### 4. íŠ¸ëŸ¬ë¸”ìŠˆíŒ…: ì„œë¹„ìŠ¤ ë ˆì´ì–´ í…ŒìŠ¤íŠ¸

#### ë¬¸ì œ ìƒí™©

- í•¨ìˆ˜ ëª¨í‚¹ì„ ì˜ëª»í•¨. (User ëª¨ë¸ì„ ì§ì ‘ ëª¨í‚¹)
- ì»¨íŠ¸ë¡¤ëŸ¬ ì•ˆì— ìˆëŠ” DBì™€ ì—°ê²°ëœ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì„œë¹„ìŠ¤ íŒŒì¼ë¡œ ë¶„ë¦¬ì‹œì¼°ìœ¼ë‚˜, í…ŒìŠ¤íŠ¸ì½”ë“œì— ë°˜ì˜í•˜ì§€ ì•Šì•˜ìŒ.
  ![Image](https://github.com/user-attachments/assets/e1ee3c0d-5c8e-4110-80ef-5aa8d77444f9)

#### í•´ê²° ë°©ë²•

- `userService.follow`ì„ ëª¨í‚¹í•œ í›„, ì»¨íŠ¸ë¡¤ëŸ¬ í…ŒìŠ¤íŠ¸ ì½”ë“œ ë‚´ìš© ìˆ˜ì •í•¨.
  ![Image](https://github.com/user-attachments/assets/4762d0ed-8304-4264-8332-b61cd09b52e9)

### 5. Promise ì²˜ë¦¬ ë°©ì‹ êµ¬ë¶„

- `mockResolvedValue`: ì •ìƒ ì‘ë‹µ (ì˜ˆ: null, "no user")
- `mockRejectedValue`: ì‹¤ì œ ì—ëŸ¬ ìƒí™©
  ```
  // Promise reject: ì˜ˆì™¸ ë°œìƒ
  Promise.reject("ì—ëŸ¬")
    .catch(err => console.error(err)); // catchë¡œ ì¡í˜

  // Promise resolve(ì—ëŸ¬): ì •ìƒì ì¸ ì‘ë‹µ
  Promise.resolve("ì—ëŸ¬")
    .then(result => console.log(result)); // thenìœ¼ë¡œ ì²˜ë¦¬ë¨
  ```

- DB ì—ëŸ¬ì˜ ê²½ìš°:
  - ì‹¤ì œ ì—ëŸ¬ ìƒí™©(DB ì—°ê²° ì‹¤íŒ¨ ë“±)ì€ `Promise.reject`
  - ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°(ì‚¬ìš©ìë¥¼ ëª» ì°¾ìŒ)ëŠ” `Promise.resolve(null)`
  ```
  // DB ì—ëŸ¬ í…ŒìŠ¤íŠ¸
  userService.follow.mockRejectedValue("DBì—ëŸ¬");

  // ì‚¬ìš©ì ëª» ì°¾ìŒ í…ŒìŠ¤íŠ¸
  userService.follow.mockResolvedValue("no user");
  ```

### 6. ì¤‘ìš” í¬ì¸íŠ¸

#### 1) done ì½œë°± ì‚¬ìš©
```
test("ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸", (done) => {
  request(app)
    .post("/auth/login")
    .expect(302, done);  // doneìœ¼ë¡œ ë¹„ë™ê¸° ì‘ì—… ì™„ë£Œ ì•Œë¦¼
});
```

#### 2) ë¦¬ë‹¤ì´ë ‰íŠ¸ í…ŒìŠ¤íŠ¸ ì½”ë“œë¡œ ì˜®ê¸°ê¸°
```
expect('Location', '/') // res.redirect('/') í…ŒìŠ¤íŠ¸
```

#### 3) ì„¸ì…˜ ìœ ì§€ í…ŒìŠ¤íŠ¸
```
const agent = request.agent(app);  // ì¿ í‚¤/ì„¸ì…˜ ìœ ì§€
```

#### 4) DB ì´ˆê¸°í™”
```
beforeAll(async () => {
  await sequelize.sync();  // í…ŒìŠ¤íŠ¸ ì „ DB ë™ê¸°í™”
});

afterAll(async () => {
  await sequelize.sync({ force: true });  // í…ŒìŠ¤íŠ¸ í›„ DB ì´ˆê¸°í™”
});
```

---

## ë¶€í•˜ í…ŒìŠ¤íŠ¸ í•´ë³´ê¸°

# 섹션10. API 서버 만들기(JWT, CORS)

1. [프로젝트 구조 갖추기](#프로젝트-구조-갖추기)
2. [JWT 토큰 발급하기](#jwt-토큰-발급하기)
3. [다른 서비스에서 호출하기](#다른-서비스에서-호출하기)
4. [SNS API 서버 만들기](#sns-api-서버-만들기)
5. [API 사용량 제한하기](#api-사용량-제한하기)
6. [CORS 에러 해결하기](#cors-에러-해결하기)

---

## 프로젝트 구조 갖추기

### API (Application Programming Interface)
- 다른 애플리케이션에서 현재 프로그램의 기능을 사용할 수 있게 허용하는 접점
- <b>웹 API</b> : 다른 웹 서비스의 기능을 사용하거나 자원을 가져올 수 있는 창구
- 흔히 API를 '열었다' 또는 '만들었다'고 표현하는데 이는 다른 프로그램에서 현재 기능을 사용할 수 있게 허용했음을 뜻함. 
    - 다른 사람에게 정보를 제공하고 싶은 부분만 API를 열어 놓고, 제공하고 싶지 않은 부분은 API를 만들지 않는 것. 
    - 또한 API를 열어놓았다 하더라도 모든 사람이 정보를 가져갈 수 있는게 아니라 인증된 사람만 일정 횟수 내에서 가져가게 제한을 둘 수도 있음. 
- <b>웹 API 서버</b>: 위와 같은 서버에 API를 올려서 URL을 통해 접근할 수 있게 만든 것

### 크롤링(crawling)
- 웹 사이트가 자체적으로 제공하는 API가 없거나 API 이용에 제한이 있을 때 사용하는 방법
- 표면적으로 보이는 <b>웹 사이트의 정보를 일정 주기로 수집해 자체적으로 가공</b>하는 기술
    - 웹 사이트에서 직접 제공하는 API가 아니므로 원하는 정보를 얻지 못할 가능성이 있음.
    - 웹 사이트에서 제공하길 원치 않는 정보를 수집한다면 법적인 문제가 발생할 수 있음. 
- 웹 사이트가 어떤 페이지의 크롤링을 허용하는지 확인하려면 `도메인/robots.txt`에 접속하면 됨.

![Image](https://github.com/user-attachments/assets/7af1ffd3-6994-4229-b2a2-407e3c52e6ba) <br>
네이버의 경우

### 순서
1. 새로운 서버 구성 및 API 폴더 생성
2. `npm init -y` 명령어
- 기본 값으로 `package.json` 파일을 자동 생성
3. 기존 프로젝트에서 필요한 파일 복사
- 기존 node_bird에서 `config`, `middlewares`, `models`, `passport`, `controllers (auth.js)`, `routes (auth.js)`, `.dotenv` 복사해서 넣기
- views에서 `error.html`, `login.html`

### 참고
- 사용자마다 다른 값을 관리할 때 uuid 사용
- `deserialize` 안하면 매번 `include`에서 그때 그때 가져오면 됨.
- findOne에서 where 안에는 undefined가 안 됨.
```
id: req.user?.id || null
```

---

## JWT 토큰 발급하기

### 1. jwt 토큰의 구조
| 구성 요소     | 설명                                                                                   |
|--------------|----------------------------------------------------------------------------------------|
| **헤더 (Header)**   | 토큰 종류와 사용된 해시 알고리즘 정보 (예: `HS256`)                                    |
| **페이로드 (Payload)** | 토큰의 내용물이 인코딩된 부분. 누구나 디코딩하여 확인할 수 있지만, 변경할 수 없음.   |
| **시그니처 (Signature)** | 비밀 키를 사용해 헤더와 페이로드를 합친 후 해시값을 생성하여 만든 서명<br> 일련의 문자열로, 토큰이 <b>위변조되었는지 여부</b>를 확인할 수 있도록 검증하는 부분.       |

- 비밀 키를 알고 있는 사람만 시그니처를 생성하고 검증할 수 있음.
- 비밀 키가 유출되면 토큰을 위조할 수 있으므로 반드시 안전하게 보관해야 함.

### 2. JWT 사용 이유
- <b>내용이 노출되지만 위조 방지가 가능</b> : JWT는 토큰의 내용이 외부에 노출될 수 있지만, 시그니처로 인해 내용의 변조를 방지할 수 있음. 이 덕분에 데이터베이스 조회 없이 사용자 정보를 빠르게 사용할 수 있음.
- <b>내용을 믿고 사용할 수 있음</b> : JWT는 내용물이 바뀌지 않으므로 사용자 정보(예: 사용자 이름, 권한)를 넣고 안전하게 사용할 수 있음. 그러나 민감한 정보는 넣지 않는 것이 좋음. (예: 비밀번호)

### 3. JWT의 단점
- <b>용량이 큼</b>: JWT는 내용이 포함되어 있어 랜덤 토큰보다 크기가 커지므로, 요청마다 전송되는 데이터의 크기가 증가함.
- <b>비용 대비 고려</b>: JWT를 사용하면 매번 데이터베이스 조회 없이 정보를 검증할 수 있지만, 그 대신 더 많은 데이터를 전송해야 하므로 비용을 비교해야 함.

---

## 다른 서비스에서 호출하기

---

## SNS API 서버 만들기

---

## API 사용량 제한하기

---

## CORS 에러 해결하기
